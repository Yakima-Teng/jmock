<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>测试页</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style type="text/css">
    body {
      margin: 0;
    }
    .wrapper {
      padding: 20px;
    }
    .textarea {
      display: block;
      width: 100%;
      height: 100px;
    }
  </style>
</head>
<body>
  <section class="wrapper">
    <button class="button" id="ajaxProxy">点击发送请求（请求代理）</button>
    <span class="text">通过配置proxyTable实现</span>
    <textarea class="textarea" id="responseProxy"></textarea>
  </section>
  <section class="wrapper">
    <button class="button" id="ajaxJSON">点击发送请求（本地JSON）</button>
    <span class="text">通过配置jsonTable实现</span>
    <textarea class="textarea" id="responseJSON"></textarea>
  </section>
  <section class="wrapper">
    <button class="button" id="ajaxCustom">点击发送请求（自定义内容）</button>
    <span class="text">通过配置customTable实现</span>
    <textarea class="textarea" id="responseCustom"></textarea>
  </section>
  <script>
    document.getElementById('ajaxProxy').addEventListener('click', function () {
      odAjax({
        method: 'GET',
        url: '/blog/v1/pages',
        data: {},
        success: function (data) { document.getElementById('responseProxy').value = data },
        error: function () {},
        complete: function () {}
      })
    }, false)

    document.getElementById('ajaxJSON').addEventListener('click', function () {
      odAjax({
        method: 'GET',
        url: '/world/example',
        data: { query: 'happy' },
        success: function (data) { document.getElementById('responseJSON').value = data },
        error: function () {},
        complete: function () {}
      })
    }, false)

    document.getElementById('ajaxCustom').addEventListener('click', function () {
      odAjax({
        method: 'POST',
        url: '/great/what',
        data: { key: 'value' },
        success: function (data) { document.getElementById('responseCustom').value = data },
        error: function () {},
        complete: function () {}
      })
    }, false)

    // ajax post
    function odAjax (obj) {
      obj = obj || {}
      // 格式化参数
      var params = (() => {
        if (obj.headers && obj.headers['Content-Type'] && obj.headers['Content-Type'].indexOf('application/json') !== -1) {
          return JSON.stringify(obj.data)
        } else {
          var arr = []
          var requestData = obj.data
          for (var key in requestData) {
            if (requestData.hasOwnProperty(key)) {
              arr.push(encodeURIComponent(key) + '=' + encodeURIComponent(requestData[key]))
            }
          }
          // 设置随机数，防止缓存
          arr.push('t=' + Math.random())
          return arr.join('&')
        }
      })()

      // 兼容性创建对象
      var xhr = (() => {
        if (window.XMLHttpRequest) {
          return new window.XMLHttpRequest()
        } else if (window.ActiveXObjectObject) {
          return new window.ActiveXObjectObject('Microsoft.XMLHTTP')
        }
      })()

      // 连接和发送
      if (obj.method === 'POST') {
        xhr.open(obj.method, obj.url, true)
        xhr.setRequestHeader('Content-Type', (obj.headers && obj.headers['Content-Type']) || 'application/x-www-form-urlencoded')
        xhr.send(params)
      } else if (obj.method === 'GET') {
        xhr.open(obj.method, obj.url + '?' + params, true)
        xhr.setRequestHeader('Content-Type', (obj.headers && obj.headers['Content-Type']) || 'application/x-www-form-urlencoded')
        xhr.send()
      }

      // 接收
      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          console.log(xhr)
          if (xhr.status >= 200 && xhr.status < 300) {
            obj.success && obj.success(xhr.responseText, xhr.responseXML)
            obj.complete && obj.complete()
          } else {
            obj.error && obj.error(xhr.status)
            obj.complete && obj.complete()
          }
        }
      }
    }
  </script>
</body>
</html>
